# System Management Network (SMN)

The 19h 01h PPR has a brief note about the SMN (from the PHY standpoint):

> System Management Network (SMN) is a packetized SOC network with a minimum 
> 8-bit packet width in each direction with either synchronous or source 
> synchronous clocking. It is expected that the packetized width of SMN may be
> adjusted to provide increased bandwidth over a SMN segment as appropriate to 
> meet SOC and IP requirements. Network and IP interface partitioning is such 
> that the IP interface is immune to changes in packet widths or other 
> characteristics of SMN.

## Host Accesses via PCIe

The Family 19h Model 01h PPR also describes a pair of IOHC registers that can 
apparently be used to issue accesses on the SMN from the host:

```
BXXD00F0x0C4 (IOHC::NB_SMN_INDEX_3)
BXXD00F0x0C8 (IOHC::NB_SMN_DATA_3)
```

These live in the PCIe configuration space for the IOHC (northbridge?); on my 
machine, this is the PCIe root complex device (ID `[1022:1480]`).
The Illumos[^1] contributors have some nice documentation about this matter.

[^1]: [illumos/illumos-gate](https://github.com/illumos/illumos-gate/blob/master/usr/src/uts/intel/sys/amdzen/smn.h)

## Memory Map

These are names for regions/registers in the SMN address space. Note that some 
of these are probably specific to a particular family or chipset - I'll try
to make note of this. 

Some other notes:

- Many of the 17h/19h PPRs record fragments of the SMN address space
- You can find lots of these in PSP binaries (and probably in firmware images
  for other cores on the die)
- `amdgpu` (in the Linux tree) seems to have a lot of registers defined in
  headers, although it's not clear if these are only relevant to the network
  on a particular APU/GPU/ASIC?


```
Address range               Description
----------------------------------------------------

[0x0001_c000 - ??????????]: Northbridge PCIe Function 0?
	[0x0001_c110]: smnDF_CS_UMC_AON0_DramBaseAddress0 (Linux)
	[0x0001_c114]: smnDF_CS_UMC_AON0_DramLimitAddress0 (Linux)
[0x0001_c400 - ??????????]: Northbridge PCIe Function 1?
[0x0001_c800 - ??????????]: Northbridge PCIe Function 2?
[0x0001_cc00 - ??????????]: Northbridge PCIe Function 3?
[0x0001_d000 - ??????????]: Northbridge PCIe Function 4?
	[0x0001_d05c]: smnDF_PIE_AON_FabricIndirectConfigAccessAddress3	 (Linux)
	[0x0001_d098]: smnDF_PIE_AON_FabricIndirectConfigAccessDataLo3 (Linux)
	[0x0001_d09c]: smnDF_PIE_AON_FabricIndirectConfigAccessDataHi3 (Linux)
	[0x0001_d140]: Related to "MBAT" permissions? (PSP_BL)
[0x0001_d400 - ??????????]: Northbridge PCIe Function 5?
	[0x0001_d440]: smnPerfMonCtlLo0 (Linux)
	[0x0001_d448]: smnPerfMonCtrLo0 (Linux)
	[0x0001_d450]: smnPerfMonCtlLo1 (Linux)
	[0x0001_d458]: smnPerfMonCtrLo1 (Linux)
	[0x0001_d460]: smnPerfMonCtlLo2 (Linux)
	[0x0001_d468]: smnPerfMonCtrLo2 (Linux)
	[0x0001_d470]: smnPerfMonCtlLo3 (Linux)
	[0x0001_d478]: smnPerfMonCtrLo3 (Linux)
[0x0001_d800 - ??????????]: Northbridge PCIe Function 6?
	[0x0001_d884]: Core::X86::Msr::McaIntrCfg? (PSP_BL)
	[0x0001_da40]: MBAT base?
	[0x0001_db40]: Related to "MBAT" entries? (PSP_BL)
[0x0001_dc00 - ??????????]: Northbridge PCIe Function 7?
[0x0001_e000 - ??????????]: ??? (used by DEBUG_UNLOCK module?)

[0x0005_0000 - ??????????]: UMC0_CH (17h,71h PPR)
[0x0005_0a00 - ??????????]: UMC-related? (PSP_BL)
[0x0005_1000 - ??????????]: ??? (PSP_BL)

[0x0005_8a14]: "MP1_SMN_C2PMSG_69?" (sof)
[0x0005_8a54]: "MP1_SMN_C2PMSG_85?" (sof)
[0x0005_8a74]: "MP1_SMN_C2PMSG_93?" (sof)

[0x0005_9800 - ??????????]: SMU_THM (17h,71h PPR)
[0x0005_a000 - ??????????]: SMU_IO? (Related to S0i3?) (PSP_BL)
[0x0005_a800 - ??????????]: ??? (PSP_BL)
	[0x0005_a86c]: Hey, this is my CPUID?

[0x0005_d000 - ??????????]: SMU_FUSE (17h,71h PPR)
[0x0005_e000 - ??????????]: Related to fuses? (PSP_BL)
[0x0015_0000 - ??????????]: UMC1_CH? (17h,71h PPR)
[0x0025_0000 - ??????????]: UMC2_CH? (17h,71h PPR)
[0x0035_0000 - ??????????]: UMC3_CH? (17h,71h PPR)

[0x0120_0000 - ??????????]: ACP_MMIO (audio coprocessor) (17h,18h PPR)
[0x01b1_0000 - ??????????]: ??? (PSP_BL)
[0x0240_0000 - ??????????]: IOMMU_MMIO (17h,18h PPR)
[0x02d0_1000 - ??????????]: ??? (PSP_BL)
[0x02dc_4000 - ??????????]: Related to SPI ROM mapping? (PSP_BL)
[0x02dc_5000 - ??????????]: ??? (PSP_BL)

[0x0301_0024]: smnMP1_FIRMWARE_FLAGS (linux)
[0x0301_0028]: smnMP1_V13_0_4_FIRMWARE_FLAGS (linux)
[0x0301_01c0]: smnMP0_FW_INTF (linux)		
[0x0380_0000 - ??????????]: "SMN_PSP_PUBLIC_BASE?" (coreboot?)
[0x0381_0000 - ??????????]: ??? (PSP_BL)
	[0x0381_0570]: PSP_MAILBOX_COMMAND_OFFSET? (coreboot?)
	[0x0381_0574]: PSP_MAILBOX_BUFFER_L_OFFSET? (coreboot?)
	[0x0381_0578]: PSP_MAILBOX_BUFFER_H_OFFSET? (coreboot?)
	[0x0381_0998]: CORE_2_PSP_MSG_38_OFFSET? (coreboot?)
	[0x0381_0994]: PSB_STATUS_OFFSET? (coreboot?)
	[0x0381_0ac8]: MP0_C2PMSG_114_REG? (linux?) (ACP?)
	[0x0381_0a24]: MP0_C2PMSG_73_REG? (linux?) (ACP?)
[0x0390_0000 - ??????????]: MP0_SRAM?? (linux?)
[0x03b0_0000 - ??????????]: MP1_PUBLIC?? (linux?)
[0x03b1_0000 - ??????????]: HSMP?
	[0x0301_0b14]: smnMP1_PUB_CTRL (linux)		
	[0x03b1_0124]: "MP1 FW Flags", some interface to SMU? (PSP_BL)
	[0x03b1_0534]: Mailbox - Message ID (19h,01h PPR)
	[0x03b1_0700 - ??????????]: ??? (PSP_BL)

[0x03c0_0000 - ??????????]: PSP_BL copies SMU_FW here?
[0x03c0_0004 - ??????????]: MP1_SRAM?? (linux?)
[0x03e1_0500 - ??????????]: MP2_C2PMSG?
[0x03e1_0680 - ??????????]: MP2_P2CMSG?

[0x03f5_6100]: ??? (PSP_BL)

[0x0900_0000 - ??????????]: AEB/SEV related? (DEBUG_UNLOCK module)
[0x090a_8000 - ??????????]: ??? (PSP_BL)
[0x0910_0000 - ??????????]: AEB/SEV related? (DEBUG_UNLOCK module)
[0x0c00_0000 - ??????????]: ??? (PSP_BL)

[0x1010_0000 - ??????????]: "nbio_nbif_bif_ras_bif_ras_regblk" (linux)
[0x1014_008c]: "smnBIF_CFG_DEV0_EPF0_DEVICE_CNTL2" (linux)
[0x1014_0324]: "smnBIF_CFG_DEV0_EPF0_PCIE_LTR_CAP" (linux)

[0x1118_0200]: "smnPCIE_PERF_COUNT_CNTL" (linux)
[0x1118_0460]: "smnCPM_CONTROL" (linux)

[0x114c_0000 - ??????????]: NBIO3_PCI_MCA0 (17h,71h PPR)
[0x118c_0000 - ??????????]: MCA_PCIE (17h,71h PPR)
[0x11af_0210]: "smnXGMI0_PCS_GOPX16_PCS_ERROR_STATUS" (Linux)

[0x12ee_0000 - ??????????]: XGMI_PCS0 (17h,31h PPR)
[0x12fe_0000 - ??????????]: XGMI_PCS1 (17h,31h PPR)
[0x130e_0000 - ??????????]: XGMI_PCS2 (17h,31h PPR)
[0x131e_0000 - ??????????]: XGMI_PCS3 (17h,31h PPR)
[0x132e_0000 - ??????????]: XGMI_PCS4 (17h,31h PPR)
[0x133e_0000 - ??????????]: XGMI_PCS5 (17h,31h PPR)
[0x136f_0000 - ??????????]: ??? (PSP_BL)
[0x13a1_0000 - ??????????]: 'nbio_iohub_nb_misc_misc_cfgdec' (linux)
[0x13a2_0000 - ??????????]: 'nbio_iohub_nb_rascfg_ras_cfgdec' (linux)
[0x13e1_0000 - ??????????]: IOHC_MISC3 (17h,71h PPR)
[0x13f0_0000 - ??????????]: IOMMU_CFG (17h,18h PPR)
[0x13f0_1000 - ??????????]: IOMMU_L2B (17h,18h PPR)
[0x1470_0000 - ??????????]: IOMMU_L1_INT0 (17h,18h PPR)
[0x1480_0000 - ??????????]: IOMMU_L1_INT1 (17h,18h PPR)
[0x1570_0000 - ??????????]: IOMMU_L2A (17h,18h PPR)

[0x178f_0000 - ??????????]: ??? (PSP_BL)
[0x17e0_0680 - ??????????]: FCH_PD_SLV_I2C? (19h,51h PPR)

[0x2000_2000 - ??????????]: ??? (PSP_BL)

[0x2035_0000 - ??????????]: L3CRB00 (17h,71h PPR)
[0x2075_0000 - ??????????]: L3CRB01 (17h,71h PPR)
[0x20b5_0000 - ??????????]: L3CRB10 (17h,71h PPR)
[0x20f5_0000 - ??????????]: L3CRB11 (17h,71h PPR)

[0x3000_0000 - ??????????]: AEB related? (DEBUG_UNLOCK module)
[0x3008_1000 - ??????????]: ??? (PSP_BL)
[0x3008_1800 - ??????????]: CCD00_FUSE_CCD_SMU_FUSE_DEC (17h,71h PPR)
[0x3030_0000 - ??????????]: ??? (PSP_BL)
[0x3040_0000 - ??????????]: CCD00_MP5_MMIO_PUBLIC (17h,71h PPR)
[0x3050_0000 - ??????????]: PSP_BL copies MP5_FW here?
[0x3060_0000 - ??????????]: ??? (PSP_BL)
[0x307f_0000 - ??????????]: ??? (PSP_BL)
[0x3208_1800 - ??????????]: CCD01_FUSE_CCD_SMU_FUSE_DEC (17h,71h PPR)
[0x3240_0000 - ??????????]: CCD01_MP5_MMIO_PUBLIC (17h,71h PPR)
```

